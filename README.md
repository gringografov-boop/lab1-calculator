# Python. Лабораторная работа: Калькулятор

### Калькулятор с алгоритмом "Шунтирующий двор"

**Автор:** Графов Григорий  
**Группа:** М80-103БВ-25  
**Дата:** Октябрь 2025

---

##  Описание

Реализация математического калькулятора с использованием алгоритма **"Шунтирующий двор"** Эдсгера Дейкстры для преобразования инфиксной записи в обратную польскую нотацию (RPN).

### Поддерживаемые операторы:
- **Арифметические:** `+`, `-`, `*`, `/`, `**`, `//`, `%`
- **Унарные:** `+`, `-` 
- **Скобки:** `()`

### Особенности:
-  Правильные приоритеты операторов
-  Правая ассоциативность степени (`2**3**2 = 512`)
-  Поддержка дробных чисел (включая `.5`)
-  Точное указание позиций ошибок с учетом пробелов
-  Компактная реализация через регулярные выражения

---

##  Структура проекта

```
project/
├── src/
│   ├── __init__.py              
│   ├── calculator.py            # Основной класс Calculator
│   └── user.py                  # Вспомогательный класс User
├── tests/
│   ├── __init__.py             
│   ├── conftest.py             # Фикстуры pytest
│   ├── test_calculator.py      # Тесты калькулятора
│   └── test_user.py            # Тесты пользователя
├── main.py                     # Запуск программы
├── pytest.ini                 # Конфигурация pytest
├── requirements.txt            # Зависимости
└── README.md                   # Документация
```

---

##  Быстрый старт

### Установка:
```bash
pip install -r requirements.txt
```

### Запуск тестов:
```bash
pytest
pytest -v  # подробный вывод
```

### Запуск программы:
```bash
python main.py
```

### Использование как модуль:
```python
from src.calculator import Calculator

calc = Calculator()
result = calc.calculate("2 + 3 * 4")
print(result)  # 14.0
```

---

##  Примеры

```python
calc = Calculator()

# Базовые операции
calc.calculate("2 + 3 * 4")        # → 14.0
calc.calculate("(2 + 3) * 4")      # → 20.0
calc.calculate("2 ** 3 ** 2")      # → 512.0

# Унарные операторы
calc.calculate("-5 + 3")           # → -2.0
calc.calculate("+5")               # → 5.0

# Дробные числа
calc.calculate(".5 + 1.5")         # → 2.0
calc.calculate("3.14 * 2")         # → 6.28

# M2 операторы
calc.calculate("17 // 5")          # → 3.0
calc.calculate("17 % 5")           # → 2.0
```

### Обработка ошибок:
```python
calc.calculate("5 / 0")            # → ZeroDivisionError
calc.calculate("1 ф + 1")          # → ValueError: позиция 2: 'ф'
calc.calculate("((2+3)")           # → ValueError: Несбалансированные скобки
```

---

##  Алгоритм

### Приоритеты (по убыванию):
1. **Унарные** `+`, `-` (4)
2. **Степень** `**` (3, правоассоциативная) 
3. **Умножение/деление** `*`, `/`, `//`, `%` (2)
4. **Сложение/вычитание** `+`, `-` (1)

### Этапы:
1. **Токенизация** - разбор строки регуляркой
2. **Преобразование в RPN** - алгоритм Дейкстры  
3. **Вычисление RPN** - стековая машина

---

##  Тестирование

### Статистика:
- **50+ тестов** основного функционала
- **Покрытие edge cases** и ошибок
- **Параметризованные тесты**

### Примеры тестов:
```python
def test_precedence(self):
    assert self.calc.calculate("2 + 3 * 4") == 14.0

def test_right_associativity(self):
    assert self.calc.calculate("2 ** 3 ** 2") == 512.0

def test_error_position(self):
    with pytest.raises(ValueError) as exc:
        self.calc.calculate("1 ф + 1")
    assert "позиции 2" in str(exc.value)
```

---

##  Ключевые особенности кода

### Токенизация с регулярными выражениями:
```python
pattern = re.compile(r'(?P<number>\d*\.\d+|\d+)|(?P<op>\*\*|//|[+\-*/%()])')
```

### Точное определение позиций ошибок:
```python
expr_nospace = ''.join(ch for ch in expr if ch != ' ')
index_map = [i for i, ch in enumerate(expr) if ch != ' ']
```

### Определение унарных операторов:
```python
if t == 'OP' and v in '+-' and (i == 0 or out and out[-1][0] in ['OP', 'LPAREN']):
    out.append(('UNARY', 'unary'+v))
```

---

##  Что изучено

- **Алгоритм "Шунтирующий двор"** Дейкстры
- **Обратная польская нотация** и стековые вычисления
- **Регулярные выражения** для парсинга
- **Pytest** для тестирования
- **Обработка ошибок** и валидация
- **Структурирование проекта** на Python

---
